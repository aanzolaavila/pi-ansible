apiVersion: v1
kind: Pod
metadata:
  name: flannel
spec:
  hostNetwork: true

  securityContext:
    privileged: true

  initContainers:
    - name: install-cni-plugin
      image: docker.io/flannel/flannel-cni-plugin:v1.5.1-flannel1
      command:
        - cp
      args:
        - -f
        - /flannel
        - /opt/cni/bin/flannel
      volumeMounts:
        - name: cni-plugin
          mountPath: /opt/cni/bin
    - name: install-cni
      image: docker.io/flannel/flannel:v0.25.4
      command:
        - cp
      args:
        - -f
        - /etc/kube-flannel/cni-conf.json
        - /etc/cni/net.d/10-flannel.conflist
      volumeMounts:
        - name: cni
          mountPath: /etc/cni/net.d
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
          readOnly: true

  containers:
    - name: etcd
      restartPolicy: Always
      image: quay.io/coreos/etcd:v3.4.33-arm64
      hostNetwork: true
      env:
        - name: ETCDCTL_API
          value: "3"
        - name: ETCD_UNSUPPORTED_ARCH
          value: "arm64"
    - name: etcd-config
      image: quay.io/coreos/etcd:v3.4.33-arm64
      restartPolicy: OnFailure
      hostNetwork: true
      env:
        - name: ETCDCTL_API
          value: "3"
        - name: ETCD_UNSUPPORTED_ARCH
          value: "arm64"
      command:
        - etcdctl
      args:
        - put
        - /coreos.com/network/config
        - '{ "Network": "10.5.0.0/16", "Backend": {"Type": "vxlan"}}'

    - name: kube-flannel
      image: docker.io/flannel/flannel:v0.25.4
      restartPolicy: Always
      command:
        - /opt/bin/flanneld
      # args:
      #   - --ip-masq
      #   - --kube-subnet-mgr
      resources:
        requests:
          cpu: "100m"
          memory: "50Mi"
      securityContext:
        privileged: false
        capabilities:
          add: ["NET_ADMIN", "NET_RAW"]
      env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: EVENT_QUEUE_DEPTH
          value: "5000"
      volumeMounts:
        - name: run
          mountPath: /run/flannel
        - name: flannel-cfg
          mountPath: /etc/kube-flannel/
          readOnly: true
        - name: xtables-lock
          mountPath: /run/xtables.lock

  volumes:
    - name: run
      hostPath:
        path: /run/flannel
    - name: cni-plugin
      hostPath:
        path: /opt/cni/bin
    - name: cni
      hostPath:
        path: /etc/cni/net.d
    - name: flannel-cfg
      hostPath:
        path: /etc/kubelet.conf.d/flannel
        type: Directory
    - name: xtables-lock
      hostPath:
        path: /run/xtables.lock
        type: FileOrCreate
